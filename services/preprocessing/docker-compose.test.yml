# Docker Compose pour les tests d'intégration
# Utilise l'infrastructure existante (Kafka, PostgreSQL)
version: '3.8'

services:
  # Service de test (utilise l'infrastructure existante)
  preprocessing-test:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: preprocessing-test
    environment:
      - SERVICE_NAME=preprocessing-service
      - SERVICE_PORT=8082
      - LOG_LEVEL=INFO
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - KAFKA_CONSUMER_GROUP=preprocessing-service
      - KAFKA_TOPIC_INPUT=sensor-data
      - KAFKA_TOPIC_OUTPUT=preprocessed-data
      - DATABASE_HOST=postgresql
      - DATABASE_PORT=5432
      - DATABASE_NAME=predictive_maintenance
      - DATABASE_USER=pmuser
      - DATABASE_PASSWORD=pmpassword
      - WINDOW_SIZE=100
      - WINDOW_OVERLAP=0.5
      - OUTLIER_THRESHOLD=3.0
      - ENABLE_DENOISING=true
      - ENABLE_FREQUENCY_ANALYSIS=true
    networks:
      - predictive-maintenance-network
    volumes:
      - ./tests:/app/tests
      - ./app:/app/app
      - ./htmlcov:/app/htmlcov
    command: pytest tests/ -v --tb=short --cov=app --cov-report=html
    # Ne pas dépendre des services (ils doivent être démarrés séparément)
    # depends_on:
    #   - kafka
    #   - postgresql

networks:
  predictive-maintenance-network:
    name: predictive-maintenance-network
    external: true
